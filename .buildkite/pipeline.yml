agents:
  queue: "mac"

steps:
  - label: "Run_RSpec_Tests"
    key: "run-rspec-tests"
    command: |
      echo "=== Debugging: Check current directory and files ==="
      pwd
      ls -la
      echo "=== Check if spec directory exists ==="
      ls -la spec/
      
      echo "=== Setting up Ruby environment ==="
      bundle install --jobs=3 --retry=3
      
      echo "=== Running RSpec tests ==="
      mkdir -p tmp
      bundle exec rspec --format progress --format RspecJunitFormatter --out tmp/junit.xml
    
    plugins:
      - docker#v5.8.0:
          image: "ruby:3.1"
          environment:
            - BUILDKITE
            - BUILDKITE_BUILD_ID
            - BUILDKITE_JOB_ID
            - BUILDKITE_STEP_ID
            - BUILDKITE_ANALYTICS_TOKEN
            - BUILDKITE_TEST_SUITE_SLUG
      
    artifact_paths:
      - "tmp/junit.xml"
    
    retry:
      automatic:
        - exit_status: "*"
          limit: 2

  - wait

  - label: "Test Results Summary"
    command: |
      echo "Tests completed successfully!"
    depends_on:
      - "run-rspec-tests"